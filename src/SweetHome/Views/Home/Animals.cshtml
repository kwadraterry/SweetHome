@model IEnumerable<SweetHome.Models.ShelterAnimal>
@using SweetHome.Models;
@using SweetHome;
@{
    ViewBag.Title = "Ищем хозяев";
    string url = Url.Action("Animals", "Home", new {});
    string dog_type = AnimalType.Dog.ToString();
    string cat_type = AnimalType.Cat.ToString();
    string blond_color = Color.Blond.ToString();
    string multi_color = Color.Varicoloured.ToString();
    string dark_color = Color.Dark.ToString();
    string small_size = Size.Small.ToString();
    string medium_size = Size.Medium.ToString();
    string large_size = Size.Large.ToString();
}

@section modal {
<div id="animal-modal"> 
    <aside>
        <section>
            <h3></h3>
            <p><a></a></p>
            <p></p>
        </section>
        <section class="gallery">
            <ul class="gallery-aux">
            </ul>
        </section>
        <section>
            <p></p>
        </section>
        <footer>
            <a></a>
            <a></a>
            <a></a>
        </footer>
        <span class="close"></span>
    </aside>
</div>
}


<div class="animals-container">
    <div class="filter-column">
        <ul>
            <li><a href="@url">Все</a></li>
            <li class="menu">
                <div><span>Приюты</span></div>
                <ul>                    
                    <li><a href="@url?shelter=1">Я живой</a></li>
                    <li><a href="@url?shelter=2">Хочу домой</a></li>
                </ul>
            </li>
            <li class="menu">
                <div><a href="@url?type=@dog_type">Собаки</a></div>
                <ul>
                    <li><a href="@url?type=@dog_type&age_less=1">Щенки</a></li>
                    <li class="menu">
                        <div><span>Размер</span></div>
                        <ul>
                            <li><a href="@url?type=@dog_type&size=@large_size">Большие</a></li>
                            <li><a href="@url?type=@dog_type&size=@medium_size">Средние</a></li>
                            <li><a href="@url?type=@dog_type&size=@small_size">Маленькие</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="menu">
                <div><a href="@url?type=@cat_type">Кошки</a></div>
                <ul>
                    <li><a href="@url?type=@cat_type&age_less=1">Котята</a></li>
                    <li class="menu">
                        <div><span>Цвет</span></div>
                        <ul>
                            <li><a href="@url?type=@cat_type&color=@blond_color">Светлые</a></li>
                            <li><a href="@url?type=@cat_type&color=@dark_color">Темные</a></li>
                            <li><a href="@url?type=@cat_type&color=@multi_color">Разноцветные</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="animals-display">
        @foreach(var animal in Model)
        {
        var jsonAnimal = SweetHome.Utils.Json.SerializeObject<Shelter>(animal, (shelter => shelter.Animals));
        <div data-animal="@jsonAnimal">
            <div class="img" style="background-image: url('@animal.Images[0]');"></div>
            <h3>@animal.Name</h3>
            @if(animal.Shelter != null)
            {
                <p><a href="@animal.Shelter.URL">@animal.Shelter.Name</a></p>
                @if (animal.Shelter.Phone != null)
                {
                <p>@animal.Shelter.Phone</p>
                }
            }
        </div>
        }
    </div>
</div>

@section scripts
{
<script>
    (function () {
        var getScrollBarWidth = function() {
            var $outer = $('<div>').css({visibility: 'hidden', width: 100, overflow: 'scroll'}).appendTo('body'),
                widthWithScroll = $('<div>').css({width: '100%'}).appendTo($outer).outerWidth();
            $outer.remove();
            return 100 - widthWithScroll;
        };
        var scroll_w = getScrollBarWidth();
        var calculate_children_height = function(el) {
            var children = $(el).children();
            var height = 0;
            for (var i = 0; i < children.length; i++)
            {
                height += children[i].clientHeight;
            }
            return height; 
        };
        $('.filter-column').on(
            'click',
            'li.menu>div',
            function(e){
                var $this = $(this);
                if (e.offsetX < 0) { // клик по псевдоэлементу
                    $this.parent().children('ul').slideToggle(500);
                    $this.parent().toggleClass("folded");
                }
            }
        );
        $(".close").click(function(){
            $(this).parents(".active").removeClass("active");
            $("body").css("overflow-y", "auto");
            $("body").css("padding-right", 0);
        });
        $("#animal-modal").click(function(e){
            if (e.target === this){
                $(this).removeClass("active");   
                $("body").css("overflow-y", "auto");
                $("body").css("padding-right", 0);
            }
        });
        require('bxslider');
        var slider = undefined;
        $("#animal-modal").on("click", ".gallery-aux li", function(e){
            var li = this;
            var ul = li.parentNode;
            var index = Array.prototype.indexOf.call(ul.children, li);
            slider.goToSlide(index);
        });
        $('[data-animal]').on('click', function() {
            var animalData = $(this).data('animal');
            console.log(animalData.Images);
            // Заполним модал данными из animalData
            $('#animal-modal>aside>section:nth-child(1)>h3')
                .html(animalData.Name);
            $('#animal-modal>aside>section:nth-child(1)>p:nth-child(2)')
                .html("Живет в приюте <a>" + animalData.Shelter.Name + "</a>");
            $('#animal-modal>aside>section:nth-child(1)>p:nth-child(2)>a')
                .attr("href","/Shelters/"+animalData.Shelter.URL);
            $('#animal-modal>aside>section:nth-child(1)>p:nth-child(3)')
                .html(animalData.Shelter.Phone);
           $('#animal-modal>aside>section:nth-child(3)>p:nth-child(1)')
                .html(animalData.Info);
            var photoElems = "";
            for (var i = 0; i < animalData.Images.length; i++) {
                var active = "";
                if (i==0) active = ' class="selected"';
                photoElems += '<li' + active + '><div class="img" style="background-image: url(\'' + animalData.Images[i] + '\');"></div></li>';
            }
            if (animalData.Images.length > 1) {
                $('#animal-modal>aside>.gallery>.gallery-aux').html(photoElems);
            } else {
                $('#animal-modal>aside>.gallery>.gallery-aux').html("");
            }
            $('#animal-modal>aside>.gallery>.bx-wrapper').remove();
            $('#animal-modal>aside>.gallery').prepend('<ul class="bxslider">' + photoElems + '</ul>');
            slider = $('#animal-modal>aside>.gallery>.bxslider').bxSlider({
                mode: 'horizontal',
                // captions: true,
                pager:  false,
                onSlideBefore: function(e, o, i) {
                    $("#animal-modal .gallery .gallery-aux li").removeClass("selected");
                    $("#animal-modal .gallery .gallery-aux li:nth-child("+ (i + 1) +")").addClass("selected");
                }
            });
            $("#animal-modal").addClass("active");
            $("body").css("overflow-y", "hidden");
            $("body").css("padding-right", scroll_w + "px");
        });
    })();
</script>
}